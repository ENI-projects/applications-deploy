stages:
  - build
  - test
  - deploy

variables:
  PROD_KUBECONFIG: prod-kubeconfig.yml
  RUNNER_IMAGE: registry.gitlab.com/startfleet/gitlab-runner:master

## Templates ##
.test-template: &test-template
  stage: test
  image: $RUNNER_IMAGE
  tags:
    - startfleet

.deploy-template: &deploy-template
  stage: deploy
  image: $RUNNER_IMAGE
  when: manual
  only:
    - tags
  tags:
    - startfleet
## End Templates ##

## Stages ##
# Build
build-kubeconfig:
  stage: build
  script:
    - echo $KUBECONFIG | base64 -d | cat $2 > $PROD_KUBECONFIG
  artifacts:
    paths:
    - prod-kubeconfig.yml
  tags:
    - startfleet

# Tests
test-namespaces:
  <<: *test-template
  script:
    - export KUBECONFIG=$PROD_KUBECONFIG
    - kubectl apply -f backend/hasura-namespace/hasura-namespace.yml --dry-run=true
    - kubectl apply -f frontend/armadacar/armadacar-namespace.yml --dry-run=true

test-services:
  <<: *test-template
  script:
    - export KUBECONFIG=$PROD_KUBECONFIG
    - kubectl apply -f backend/hasura-namespace/hasura/hasura-service.yml --dry-run=true
    - kubectl apply -f frontend/armadacar/service.yml --dry-run=true

test-deployments:
  <<: *test-template
  script:
    - export KUBECONFIG=$PROD_KUBECONFIG
    - kubectl apply -f backend/hasura-namespace/hasura/hasura-deployment.yml --dry-run=true
    - kubectl apply -f frontend/armadacar/deployment.yml --dry-run=true

# Deploy
deploy-namespaces:
  <<: *deploy-template
  script:
    - export KUBECONFIG=$PROD_KUBECONFIG
    - kubectl apply -f backend/hasura-namespace/hasura-namespace.yml
    - kubectl apply -f frontend/armadacar/armadacar-namespace.yml

deploy-hasura:
  <<: *deploy-template
  script:
    - export KUBECONFIG=$PROD_KUBECONFIG
    # building the deployment with substrings 
    - envsubst < backend/hasura-namespace/hasura/hasura-deployment.yml > Hasura-Deployment.yml
    - kubectl -n hasura apply -f Hasura-Deployment.yml
    # building hasura service
    - kubectl -n hasura apply -f backend/hasura-namespace/hasura/hasura-service.yml

deploy-armadacar:
  <<: *deploy-template
  script:
    - export KUBECONFIG=$PROD_KUBECONFIG
    - kubectl -n armadacar apply -f frontend/armadacar/deployment.yml
    - kubectl -n armadacar apply -f frontend/armadacar/service.yml